name: Sync dev/examples to inst/scripts

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "dev/examples/**"
      - ".github/workflows/sync-examples.yml"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v5

      - name: Copy dev/examples -> inst/scripts/examples and patch R files
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p inst/scripts
          rm -rf inst/scripts/examples
          cp -a dev/examples inst/scripts/

          # 1) remove dev/glob_funds/
          # 2) insert library(fundsr) immediately after library(tidyverse)
          find inst/scripts/examples -type f -name "*.R" -print0 |
            xargs -0 perl -pi -e '
              s#dev/glob_funds/##g;
             s/^(\h*library\(\h*tidyverse\h*\)\h*\R)/$1library(fundsr)\n/m;
            '

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v7
        with:
          branch: automation/sync-inst-scripts
          title: "Sync inst/scripts/examples from dev/examples/"
          commit-message: "Sync inst/scripts/examples from dev/examples/"
          body: |
            Auto-generated by GitHub Actions.

            - Copies `dev/examples/` to `inst/scripts/examples/`
            - Removes `dev/glob_funds/` from paths in `*.R`
            - Adds `library(fundsr)` after `library(tidyverse)`
          labels: |
            automation
